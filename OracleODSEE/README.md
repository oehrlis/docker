# Oracle Directory Server Enterprise Edition on Docker
Docker base image used for miscellaneous Oracle Directory Server Enterprise Edition engineering .
Docker build files to facilitate installation, configuration, and environment setup for Docker DevOps users. For more information about Oracle Directory Server Enterprise Edition please see the [Oracle Directory Server Enterprise Edition 11.1.1.7.2 Online Documentation](https://docs.oracle.com/cd/E29127_01/index.htm).

## Content

This docker image is based on the official Oracle Linux slim image ([oraclelinux](https://hub.docker.com/r/_/oraclelinux/)). It has been extended with the following Linux packages and configuration:
* Install the following additional packages including there dependencies:
    - *unzip* A utility for unpacking zip files
    - *zip* A file compression and packaging utility compatible with PKZIP
    - *tar* A GNU file archiving program
    - *gzip* The GNU data compression program
    - *procps-ng* System and process monitoring utilities
    - *libstdc++.i686* GNU Standard C++ Library for i686
    - *libstdc++.x86_64* GNU Standard C++ Library for x86_64
    * *glibc.i686* The GNU libc libraries for i686
    * *zlib.i686* The compression and decompression library for i686
* Operating system user *oracle* (uid 1000)
* Dedicated groups for user *oracle*, oracle (gid 1000), oinstall (gid 1010)
* ~~[OUD Base](https://github.com/oehrlis/oudbase) environment developed by [ORAdba](www.oradba.ch)~~
* Oracle OFA Directories see below
* Oracle Directory Server Enterprise Edition 11.1.1.7.171017

### Environment Variable and Directories
Based on the idea of OFA (Oracle Flexible Architecture) we try to separate the data from the binaries. This means that the OUD instance as well as configuration files are explicitly stored in a separate directory. Ideally, a volume is assigned to this directory when a container is created. This ensures data persistence over the lifetime of a container. OUD Base supports the setup and operation of the environment based on OFA. See also [OraDBA](http://www.oradba.ch/category/oudbase/).

The following environment variables have been used for the installation. In particular it is possible to modify the variables ORACLE_ROOT, ORACLE_DATA and ORACLE_BASE via *build-arg* during image build to have a different directory structure. All other parameters are only relevant for the creation of the container. They may be modify via ```docker run``` environment variables.


export ODSEE_INSTANCE=${:-dsDocker}

# Flag to create instance on first boot
export CREATE_INSTANCE=${CREATE_INSTANCE:-'TRUE'}

# ODSEE instance base directory
export OUD_INSTANCE_BASE=${OUD_INSTANCE_BASE:-"$ORACLE_DATA/instances"}

# ODSEE instance home directory
export ODSEE_INSTANCE_HOME=${OUD_INSTANCE_BASE}/${ODSEE_INSTANCE}
export ODSEE_HOME=${ORACLE_BASE}/product/${ORACLE_HOME_NAME}


Environment variable | Value / Directories                      | Modifiable   | Comment
-------------------- | ---------------------------------------- | -------------| ---------------
ORACLE_ROOT          | ```/u00```                               | docker build | Root directory for all the Oracle software
ORACLE_BASE          | ```$ORACLE_ROOT/app/oracle```            | docker build | Oracle base directory
n/a                  | ```$ORACLE_BASE/product```               | no           | Oracle product base directory
ORACLE_HOME_NAME     | ```dsee7```                              | no           | Name of the Oracle Home, used to create to PATH to ORACLE_HOME eg. *$ORACLE_BASE/product/$ORACLE_HOME_NAME*
ORACLE_DATA          | ```/u01```                               | docker build | Root directory for the persistent data eg. ODSEE instances, etc. A docker volumes must be defined for */u01*
INSTANCE_BASE        | ```$ORACLE_DATA/instances```             | no           | Base directory for ODSEE instances
ODSEE_INSTANCE       | ```dsDocker```                           | docker run   | Default name for ODSEE instance
ODSEE_INSTANCE_HOME  | ```${INSTANCE_BASE}/${ODSEE_INSTANCE}``` | docker run   |
CREATE_INSTANCE      | ```TRUE```                               | docker run   | Flag to create ODSEE instance on first start of the container
OUD_INSTANCE_INIT    | ```$ORACLE_DATA/scripts```               | docker run   | Directory for the instance configuration scripts
PORT                 | ```1389```                               | docker run   | Default LDAP port for the OUD instance
PORT_SSL             | ```1636```                               | docker run   | Default LDAPS port for the OUD instance
ADMIN_USER           | ```cn=Directory Manager```               | docker run   | Default admin user for OUD instance
ADMIN_PASSWORD       |  n/a                                     | docker run   | No default password. Password will be autogenerated when not defined.
BASEDN               | ```dc=postgasse,dc=org```                | docker run   | Default directory base DN
SAMPLE_DATA          | ```TRUE```                               | docker run   | Flag to load sample data. Not yet implemented.
ETC_BASE             | ```$ORACLE_DATA/etc```                   | no           | Oracle etc directory with configuration files
LOG_BASE             | ```$ORACLE_DATA/log```                   | no           | Oracle log directory with log files
DOWNLOAD             | ```/tmp/download```                      | no           | Temporary download directory, will be removed after build
DOCKER_BIN           | ```/opt/docker/bin```                    | no           | Docker build and setup scripts
other minor release.

In general it does not make sense to change all possible variables. Although *BASEDN* and *ADMIN_PASSWORD* are good candidates for customization. all other variables can generally easily be ignored.

### Scripts to Build and Setup
The following scripts are used either during Docker image build or while setting up and starting the container.

| Script                       | Purpose
| ---------------------------- | ----------------------------------------------------------------------------
| ```check_odsee_instance.sh```  | Check the status of the ODSEE instance for Docker HEALTHCHECK
| ```config_odsee_instance.sh``` | Configure ODSEE instance using custom scripts
| ```create_odsee_instance.sh``` | Script to create the ODSEE instance
| ```start_odsee_instance.sh```  | Script to start the ODSEE instance

## Installation and build
The Docker images have to be build manually based on [oehrlis/docker](https://github.com/oehrlis/docker) from GitHub. The required software has to be downloaded prior image build and must be part of the build context or made available in a local HTTP server. See [Build with local HTTP server](#build-with-local-http-server) below. When providing a local HTTP server to download the required software during image build will lead into smaller images, since the software will not be part of an intermediate intermediate container. The procedure was briefly described in the blog post [Smaller Oracle Docker images](http://www.oradba.ch/2018/03/smaller-oracle-docker-images/).

### Obtaining Product Distributions
The Oracle Software required to setup an Oracle Unified Directory Docker image is basically not public available. It is subject to Oracle's license terms. For this reason a valid license is required (eg. [OTN Developer License Terms](http://www.oracle.com/technetwork/licenses/standard-license-152015.html)). In addition, Oracle's license terms and conditions must be accepted before downloading.

The following software is required for the Oracle Unified Directory Docker image:
* Oracle Directory Server Enterprise Edition 11.1.1.7.0. Alternatively you may use the latest patch release via MOS Patch ID [26724938](https://updates.oracle.com/ARULink/PatchDetails/process_form?patch_num=26724938)

The software can either be downloaded from [My Oracle Support (MOS)](https://support.oracle.com), [Oracle Technology Network (OTN)](http://www.oracle.com/technetwork/index.html) or [Oracle Software Delivery Cloud (OSDC)](http://edelivery.oracle.com). The following links refer to the MOS software download to simplify the build process.

The corresponding links and checksum can be found in `*.download` files. Alternatively the Oracle Support Download Links:
* Oracle Directory Server Enterprise Edition 11.1.1.7.0 [Patch 26724938](https://updates.oracle.com/ARULink/PatchDetails/process_form?patch_num=26724938) or [direct](https://updates.oracle.com/Orion/Services/download/p26724938_111170_Linux-x86-64.zip?aru=21522204&patch_file=p26724938_111170_Linux-x86-64.zip)

### Build using COPY
Simplest method to build the ODSEE image is to manually download the required software and put it into the build folder respectively context. However this will lead to bigger Docker images, since the software is copied during build, which temporary blow up the container file-system.

Copy all files to the `OracleODSEE/11.1.1.7.0` folder.

        cp p26724938_111170_Linux-x86-64.zip OracleODSEE/11.1.1.7.0

Build the docker image using `docker build`.

        cd OracleODSEE/11.1.1.7.0
        docker build -t oracle/odsee:11.1.1.7.0 .

### Build with local HTTP server
Alternatively the software can also be downloaded from a local HTTP server during build. For this a Docker image for an HTTP server is required eg. official Apache HTTP server Docker image based on alpine. 

Start a local HTTP server. httpd:alpine will be pulled from Docker Hub:

        docker run -dit --hostname orarepo --name orarepo \
            -p 8080:80 \
            -v /Data/vm/docker/volumes/orarepo:/usr/local/apache2/htdocs/ \
            httpd:alpine

Make sure, that the software is not copied to the volume folder not in the build context any more:

        cd OracleODSEE/11.1.1.7.0
        cp p26724938_111170_Linux-x86-64.zip /Data/vm/docker/volumes/orarepo
        rm p26724938_111170_Linux-x86-64.zip

Get the IP address of the local HTTP server:

        orarepo_ip=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' orarepo)

Build the docker image using `docker build` and provide the HTTP server.

        docker build --add-host=orarepo:${orarepo_ip} -t oracle/odsee:11.1.1.7.0 .

The _RUN_ command in the Dockerfile will check if the software is part of the build context. If not, it will use the host _orarepo_ to download the software. This way the OUD Docker image will be about 400MB smaller.

## Running the Docker Images
### Setup an Oracle Directory Server Enterprise Edition Container
Creating a ODSEE container is straight forward with **docker run** command. The script `start_odsee_instance.sh` will make sure, that a new ODSEE instance is created, when the container is started the first time.  The instance is created using predefined values. (see below). If an ODSEE instance already exists, the script simply starts it.

The creation of the ODSEE instance can be influenced by the following environment variables. You only have to set them with option -e when executing "docker run":

* **ADMIN_PASSWORD** ODSEE admin password (default *autogenerated*)
* **ADMIN_USER**  ODSEE admin user name (default *cn=Directory Manager*)
* **BASEDN** Directory base DN (default *dc=postgasse,dc=org*)
* **LDAPS_PORT** SSL LDAP port (default *1636*)
* **LDAP_PORT** Regular LDAP port (default *1389*)
* **ODSEE_INSTANCE** ODSEE instance name (default *oud_docker*)
* **ODSEE_INSTANCE_HOME** ODSEE home path (default */u01/instances/oud_docker*)
* **ODSEE_INSTANCE_INIT** default folder for ODSEE instance init scripts. These scripts are used to modify and adjust the new ODSEE instance.

Run your Oracle Directory Server Enterprise Edition Docker image use the **docker run** command as follows:

    docker run --name odsee <container name> \
    --hostname <container hostname> -P \
    -e ODSEE_INSTANCE=<your odsee instance name> \
    --volume [<host mount point>:]/u01 \
    --volume [<host mount point>:]/u01/scripts \
    oracle/odsee:11.1.1.7.0

    Parameters:
    --name:            The name of the container (default: auto generated)
    -p:                The port mapping of the host port to the container port.
                       for ports are exposed: 1389 (LDAP), 1636 (LDAPS), 4444 (Admin Port), 8989 (Replication Port)
    -P:                Map all exposed ports
    -e ODSEE_INSTANCE: The Oracle Database SYS, SYSTEM and PDB_ADMIN password (default: auto generated)
    -e <Variables>     Other environment variable according "Environment Variable and Directories"
    -v /u01
                       The data volume to use for the OUD instance.
                       Has to be writable by the Unix "oracle" (uid: 1000) user inside the container!
                       If omitted the OUD instance will not be persisted over container recreation.
    -v /u01/app/oracle/scripts | /docker-entrypoint-initdb.d
                       Optional: A volume with custom scripts to be run after OUD instance setup.
                       For further details see the "Running scripts after setup" section below.

There are four ports that are exposed in this image:
* 1389 which is the regular LDAP port to connect to the ODSEE instance.
* 1636 which is the SSL LDAP port to connect to the ODSEE instance.

On the first startup of the container a random password will be generated for the ODSEE instance if not provided. You can find this password in the output line:
If you need to find the passwords at a later time, grep for "password" in the Docker logs generated during the startup of the container. To look at the Docker Container logs run:

        docker logs --details oud|grep -i password

#### Running Bash in a Docker container
Access your ODSEE container via bash.

        docker exec -u oracle -it oud bash --login

#### Running scripts after setup
The ODSEE Docker image can be configured to run scripts after setup. Currently `sh` and `ldif` extensions are supported. For post-setup scripts just create a folder `scripts/setup` in generic volume `/u01`, mount a dedicated volume `/u01/scripts/setup` or extend the image to include scripts in this directory. The location is also represented under the symbolic link `/docker-entrypoint-initdb.d`. This is done to provide synergy with other Docker images. The user is free to decide whether he wants to put his setup scripts under `/u01/scripts/setup` or `/docker-entrypoint-initdb.d`.

After the ODSEE instance is setup the scripts in those folders will be executed against the instance in the container. LDIF files (`ldif`) will be loaded using `ldapmodify` as *cn=Directory Manager* (ADMIN_USER). Shell scripts will be executed as the current user (oracle). To ensure proper order it is recommended to prefix your scripts with a number. For example `01_instance.sh`, `02_schema_extention.ldif`, etc.

## Frequently asked questions
Please see [FAQ.md](./FAQ.md) for frequently asked questions.

## Issues
Please file your bug reports, enhancement requests, questions and other support requests within [Github's issue tracker](https://help.github.com/articles/about-issues/):

* [Existing issues](https://github.com/oehrlis/docker/issues)
* [submit new issue](https://github.com/oehrlis/docker/issues/new)

## License
oehrlis/docker is licensed under the GNU General Public License v3.0. You may obtain a copy of the License at <https://www.gnu.org/licenses/gpl.html>.

To download and run Oracle Unified Directory, Oracle Directory Server Enterprise Edition or any other Oracle product, regardless whether inside or outside a Docker container, you must download the binaries from the Oracle website and accept the license indicated at that page. See [OTN Developer License Terms](http://www.oracle.com/technetwork/licenses/standard-license-152015.html) and [Oracle Database Licensing Information User Manual](https://docs.oracle.com/database/122/DBLIC/Licensing-Information.htm#DBLIC-GUID-B6113390-9586-46D7-9008-DCC9EDA45AB4)
